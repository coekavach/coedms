<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Tab Data Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
            color: #212529;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 24px;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .header p {
            color: #6c757d;
            font-size: 14px;
        }

        /* Tab Styles */
        .tabs {
            background: white;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 0;
            overflow: hidden;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #dee2e6;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-button:hover {
            background: #e9ecef;
            color: #495057;
        }

        .tab-button.active {
            background: white;
            color: #007bff;
            border-bottom-color: #007bff;
        }

        .tab-content {
            background: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .filters {
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
        }

        .filter-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .filter-input {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            transition: border-color 0.2s;
        }

        .filter-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        .refresh-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
            white-space: nowrap;
        }

        .refresh-btn:hover:not(:disabled) {
            background: #0056b3;
        }

        .refresh-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .status {
            padding: 12px 16px;
            border-radius: 4px;
            margin: 20px;
            font-size: 14px;
            display: none;
        }

        .status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.success {
            background: #d1edff;
            color: #0c5460;
            border: 1px solid #b8daff;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .table-header {
            padding: 16px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-weight: 600;
            color: #495057;
        }

        .record-count {
            font-size: 14px;
            color: #6c757d;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead th {
            background: #f8f9fa;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
        }

        tbody td {
            padding: 12px 16px;
            border-bottom: 1px solid #dee2e6;
            vertical-align: top;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .priority-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-normal {
            background: #e3f2fd;
            color: #1976d2;
        }

        .priority-high {
            background: #ffebee;
            color: #d32f2f;
        }

        .priority-low {
            background: #e8f5e8;
            color: #388e3c;
        }

        .category-cell {
            font-size: 13px;
        }

        .category-main {
            font-weight: 600;
            color: #495057;
        }

        .category-sub {
            color: #6c757d;
            font-size: 12px;
        }

        .subject-cell {
            max-width: 300px;
            word-wrap: break-word;
            font-size: 13px;
            line-height: 1.4;
        }

        .file-link {
            color: #007bff;
            text-decoration: none;
            font-size: 13px;
        }

        .file-link:hover {
            text-decoration: underline;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .error-solutions {
            margin-top: 20px;
            padding: 20px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
        }

        .error-solutions h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .error-solutions ol {
            color: #856404;
            margin-left: 20px;
        }

        .sample-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            margin-top: 15px;
        }

        .sample-btn:hover {
            background: #218838;
        }

        @media (max-width: 768px) {
            .tab-buttons {
                flex-direction: column;
            }

            .filter-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .filter-row .refresh-btn {
                justify-self: start;
            }

            .table-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .subject-cell {
                max-width: 200px;
            }

            thead th,
            tbody td {
                padding: 8px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Railway Data Management System</h1>
            <p>View and filter documents from KMP, RDSO, and Railway Board</p>
        </div>

        <div class="tabs">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('kmp')">KMP Advanced Search</button>
                <button class="tab-button" onclick="switchTab('rdso')">RDSO</button>
                <button class="tab-button" onclick="switchTab('railway-board')">Railway Board</button>
            </div>

            <!-- KMP Tab -->
            <div class="tab-content active" id="kmp-tab">
                <div class="filters">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Search All</label>
                            <input type="text" class="filter-input" placeholder="Search records..." id="kmp-searchAll">
                        </div>
                        <div class="filter-group">
                            <label>Category</label>
                            <select class="filter-input" id="kmp-categoryFilter">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Priority</label>
                            <select class="filter-input" id="kmp-priorityFilter">
                                <option value="">All Priorities</option>
                                <option value="High">High</option>
                                <option value="Normal">Normal</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Date From</label>
                            <input type="date" class="filter-input" id="kmp-dateFilter">
                        </div>
                        <button class="refresh-btn" onclick="fetchKMPData()" id="kmp-refreshBtn">
                            Refresh
                        </button>
                    </div>
                </div>

                <div class="status" id="kmp-status"></div>

                <div class="table-header">
                    <div class="table-title">KMP Records</div>
                    <div class="record-count" id="kmp-recordCount">0 records</div>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Category</th>
                                <th>Priority</th>
                                <th>Date</th>
                                <th>Letter Number</th>
                                <th>Subject</th>
                                <th>File</th>
                            </tr>
                        </thead>
                        <tbody id="kmp-tableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- RDSO Tab -->
            <div class="tab-content" id="rdso-tab">
                <div class="filters">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Search All</label>
                            <input type="text" class="filter-input" placeholder="Search records..." id="rdso-searchAll">
                        </div>
                        <div class="filter-group">
                            <label>Category</label>
                            <select class="filter-input" id="rdso-categoryFilter">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Priority</label>
                            <select class="filter-input" id="rdso-priorityFilter">
                                <option value="">All Priorities</option>
                                <option value="High">High</option>
                                <option value="Normal">Normal</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Date From</label>
                            <input type="date" class="filter-input" id="rdso-dateFilter">
                        </div>
                        <button class="refresh-btn" onclick="fetchRDSOData()" id="rdso-refreshBtn">
                            Refresh
                        </button>
                    </div>
                </div>

                <div class="status" id="rdso-status"></div>

                <div class="table-header">
                    <div class="table-title">RDSO Records</div>
                    <div class="record-count" id="rdso-recordCount">0 records</div>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Category</th>
                                <th>Priority</th>
                                <th>Date</th>
                                <th>Letter Number</th>
                                <th>Subject</th>
                                <th>File</th>
                            </tr>
                        </thead>
                        <tbody id="rdso-tableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Railway Board Tab -->
            <div class="tab-content" id="railway-board-tab">
                <div class="filters">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Search All</label>
                            <input type="text" class="filter-input" placeholder="Search records..." id="rb-searchAll">
                        </div>
                        <div class="filter-group">
                            <label>Category</label>
                            <select class="filter-input" id="rb-categoryFilter">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Priority</label>
                            <select class="filter-input" id="rb-priorityFilter">
                                <option value="">All Priorities</option>
                                <option value="High">High</option>
                                <option value="Normal">Normal</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Date From</label>
                            <input type="date" class="filter-input" id="rb-dateFilter">
                        </div>
                        <button class="refresh-btn" onclick="fetchRailwayBoardData()" id="rb-refreshBtn">
                            Refresh
                        </button>
                    </div>
                </div>

                <div class="status" id="rb-status"></div>

                <div class="table-header">
                    <div class="table-title">Railway Board Records</div>
                    <div class="record-count" id="rb-recordCount">0 records</div>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Category</th>
                                <th>Priority</th>
                                <th>Date</th>
                                <th>Letter Number</th>
                                <th>Subject</th>
                                <th>File</th>
                            </tr>
                        </thead>
                        <tbody id="rb-tableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        let kmpData = [];
        let rdsoData = [];
        let railwayBoardData = [];
        
        const KMP_API_URL = 'https://coekms.in/Api/UploadData';
        const GOOGLE_SHEET_BASE_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSlXoH4ekrswe0-BRLB4ZSx8cGjn-3OK-BGcvStNnuOKALm9IfakG4NTOLcYVM6dE7GgQx2f4qNEMDp/pub?output=csv';
        
        let activeTab = 'kmp';

        // Tab switching functionality
        function switchTab(tabName) {
            // Update button states
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // Update content visibility
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            activeTab = tabName;
            
            // Load data for the active tab if not already loaded
            if (tabName === 'kmp' && kmpData.length === 0) {
                fetchKMPData();
            } else if (tabName === 'rdso' && rdsoData.length === 0) {
                fetchRDSOData();
            } else if (tabName === 'railway-board' && railwayBoardData.length === 0) {
                fetchRailwayBoardData();
            }
        }

        // Format date function
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return isNaN(date.getTime()) ? dateString : date.toLocaleDateString('en-GB');
        }

        // Get priority class
        function getPriorityClass(priority) {
            if (!priority) return 'priority-normal';
            return `priority-${priority.toLowerCase()}`;
        }

        // Extract filename from path
        function getFileName(filePath) {
            if (!filePath) return 'No File';
            return filePath.split('/').pop().split('_').slice(1).join('_') || 'View File';
        }

        // Create table row for KMP data
        function createKMPTableRow(item) {
            return `
                <tr>
                    <td>${item.id || ''}</td>
                    <td class="category-cell">
                        <div class="category-main">${item.category || ''}</div>
                        <div class="category-sub">${item.subcategory || ''}</div>
                    </td>
                    <td><span class="priority-badge ${getPriorityClass(item.priority)}">${item.priority || 'Normal'}</span></td>
                    <td>${formatDate(item.letter_date)}</td>
                    <td>${item.letter_number || ''}</td>
                    <td class="subject-cell">${item.subject_of_letter || ''}</td>
                    <td>
                        ${item.upload_file ? `
                            <a href="https://coekms.in/${item.upload_file}" 
                               target="_blank" 
                               class="file-link">
                                ${getFileName(item.upload_file)}
                            </a>
                        ` : 'No File'}
                    </td>
                </tr>
            `;
        }

        // Create table row for Google Sheets data
        function createGoogleSheetsTableRow(item, index) {
            return `
                <tr>
                    <td>${index + 1}</td>
                    <td class="category-cell">
                        <div class="category-main">${item.Category || ''}</div>
                        <div class="category-sub">${item.Subcategory || ''}</div>
                    </td>
                    <td><span class="priority-badge ${getPriorityClass(item.Priority)}">${item.Priority || 'Normal'}</span></td>
                    <td>${formatDate(item['Letter Date'] || item.Date)}</td>
                    <td>${item['Letter Number'] || ''}</td>
                    <td class="subject-cell">${item['Subject of Letter'] || item.Subject || ''}</td>
                    <td>
                        ${item['File URL'] || item.File ? `
                            <a href="${item['File URL'] || item.File}" 
                               target="_blank" 
                               class="file-link">
                                View File
                            </a>
                        ` : 'No File'}
                    </td>
                </tr>
            `;
        }

        // Update status
        function updateStatus(tabPrefix, message, type) {
            const statusDiv = document.getElementById(`${tabPrefix}-status`);
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }

        // Update record count
        function updateRecordCount(tabPrefix, count) {
            document.getElementById(`${tabPrefix}-recordCount`).textContent = `${count} record${count !== 1 ? 's' : ''}`;
        }

        // Populate category filter
        function populateCategoryFilter(tabPrefix, data) {
            const categoryFilter = document.getElementById(`${tabPrefix}-categoryFilter`);
            let categories = [];
            
            if (tabPrefix === 'kmp') {
                categories = [...new Set(data.map(item => item.category).filter(Boolean))].sort();
            } else {
                categories = [...new Set(data.map(item => item.Category).filter(Boolean))].sort();
            }
            
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            categories.forEach(category => {
                categoryFilter.innerHTML += `<option value="${category}">${category}</option>`;
            });
        }

        // Fetch KMP data from API
        async function fetchKMPData() {
            const refreshBtn = document.getElementById('kmp-refreshBtn');
            const tableBody = document.getElementById('kmp-tableBody');
            
            try {
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'Loading...';
                updateStatus('kmp', 'Loading data from KMP API...', 'loading');

                let response;
                let result;
                
                try {
                    response = await fetch(KMP_API_URL);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    result = await response.json();
                } catch (corsError) {
                    console.log('Direct fetch failed, trying CORS proxy...');
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(KMP_API_URL)}`;
                    
                    try {
                        response = await fetch(proxyUrl);
                        if (!response.ok) {
                            throw new Error(`Proxy error! status: ${response.status}`);
                        }
                        result = await response.json();
                    } catch (proxyError) {
                        console.log('First proxy failed, trying alternative...');
                        const altProxyUrl = `https://corsproxy.io/?${encodeURIComponent(KMP_API_URL)}`;
                        response = await fetch(altProxyUrl);
                        if (!response.ok) {
                            throw new Error(`Alternative proxy error! status: ${response.status}`);
                        }
                        result = await response.json();
                    }
                }
                
                if (result.success && result.data) {
                    kmpData = result.data;
                    populateCategoryFilter('kmp', kmpData);
                    
                    if (kmpData.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="7" class="no-data">No data available</td></tr>';
                        updateRecordCount('kmp', 0);
                    } else {
                        applyFilters('kmp');
                        updateStatus('kmp', `Successfully loaded ${kmpData.length} records`, 'success');
                    }
                } else {
                    throw new Error('Invalid API response format');
                }
            } catch (error) {
                console.error('Error fetching KMP data:', error);
                updateStatus('kmp', 'Failed to load KMP data. Loading sample data instead.', 'error');
                loadKMPSampleData();
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'Refresh';
            }
        }

        // Fetch RDSO data from Google Sheets
        async function fetchRDSOData() {
            const refreshBtn = document.getElementById('rdso-refreshBtn');
            const tableBody = document.getElementById('rdso-tableBody');
            
            try {
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'Loading...';
                updateStatus('rdso', 'Loading RDSO data from Google Sheets...', 'loading');

                const sheetUrl = `${GOOGLE_SHEET_BASE_URL}&gid=0`; // Assuming RDSO is the first sheet
                const response = await fetch(sheetUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        if (results.errors.length > 0) {
                            console.warn('CSV parsing errors:', results.errors);
                        }
                        
                        rdsoData = results.data.filter(row => 
                            Object.values(row).some(value => value && value.trim())
                        );
                        
                        populateCategoryFilter('rdso', rdsoData);
                        
                        if (rdsoData.length === 0) {
                            tableBody.innerHTML = '<tr><td colspan="7" class="no-data">No RDSO data available</td></tr>';
                            updateRecordCount('rdso', 0);
                        } else {
                            applyFilters('rdso');
                            updateStatus('rdso', `Successfully loaded ${rdsoData.length} RDSO records`, 'success');
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error fetching RDSO data:', error);
                updateStatus('rdso', 'Failed to load RDSO data from Google Sheets', 'error');
                tableBody.innerHTML = '<tr><td colspan="7" class="no-data">Failed to load RDSO data</td></tr>';
                updateRecordCount('rdso', 0);
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'Refresh';
            }
        }

        // Fetch Railway Board data from Google Sheets
        async function fetchRailwayBoardData() {
            const refreshBtn = document.getElementById('rb-refreshBtn');
            const tableBody = document.getElementById('rb-tableBody');
            
            try {
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'Loading...';
                updateStatus('rb', 'Loading Railway Board data from Google Sheets...', 'loading');

                const sheetUrl = `${GOOGLE_SHEET_BASE_URL}&gid=1`; // Assuming Railway Board is the second sheet
                const response = await fetch(sheetUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        if (results.errors.length > 0) {
                            console.warn('CSV parsing errors:', results.errors);
                        }
                        
                        railwayBoardData = results.data.filter(row => 
                            Object.values(row).some(value => value && value.trim())
                        );
                        
                        populateCategoryFilter('rb', railwayBoardData);
                        
                        if (railwayBoardData.length === 0) {
                            tableBody.innerHTML = '<tr><td colspan="7" class="no-data">No Railway Board data available</td></tr>';
                            updateRecordCount('rb', 0);
                        } else {
                            applyFilters('rb');
                            updateStatus('rb', `Successfully loaded ${railwayBoardData.length} Railway Board records`, 'success');
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error fetching Railway Board data:', error);
                updateStatus('rb', 'Failed to load Railway Board data from Google Sheets', 'error');
                tableBody.innerHTML = '<tr><td colspan="7" class="no-data">Failed to load Railway Board data</td></tr>';
                updateRecordCount('rb', 0);
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'Refresh';
            }
        }

        // Load sample KMP data
        function loadKMPSampleData() {
            const sampleData = [
                {
                    "id": 143,
                    "category": "Kavach",
                    "subcategory": "Advisories",
                    "priority": "Normal",
                    "letter_date": "2025-05-07",
                    "letter_number": "MEDHA1",
                    "subject_of_letter": "MEDHA TEST LETTER TO COE",
                    "upload_file": "uploads/1748610721_Declaration by CalAmp US reg Opening of Guardian Radio Protocols.pdf"
                },
                {
