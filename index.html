<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kavach Documents</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }

        .tab-container {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            margin-bottom: 10px;
        }

        .tab-container button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 17px;
        }

        .tab-container button:hover {
            background-color: #ddd;
        }

        .tab-container button.active {
            background-color: #ccc;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            padding: 15px 12px;
            border: 1px solid #ccc;
            border-top: none;
            background-color: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 14px;
            word-wrap: break-word; /* Helps prevent long strings from breaking layout */
        }

        th {
            background-color: #e9e9e9;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        a {
            color: #007bff;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        .loader {
            border: 5px solid #f3f3f3; /* Light grey */
            border-top: 5px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <h1>Kavach Related Documents</h1>

    <div class="tab-container">
        <button class="tab-button" id="defaultOpen" onclick="openTab(event, 'RDSO')">RDSO</button>
        <button class="tab-button" onclick="openTab(event, 'RailwayBoard')">Railway Board</button>
    </div>

    <div id="RDSO" class="tab-content">
        <h2>RDSO Specifications & Test Formats</h2>
        <div class="loader" id="loaderRDSO"></div>
        <table id="rdsoTable">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="RailwayBoard" class="tab-content">
        <h2>Railway Board Policy Letters & Circulars</h2>
        <div class="loader" id="loaderRailwayBoard"></div>
        <table id="railwayBoardTable">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        function openTab(evt, tabId) {
            var i, tabcontent, tabbuttons;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
            }
            document.getElementById(tabId).style.display = "block";
            if (evt) { // Check if evt is passed (not for initial default open)
                evt.currentTarget.className += " active";
            } else { // For initial default open
                 document.getElementById('defaultOpen').className += " active";
            }
        }

        // More robust CSV parser to handle quoted fields with commas
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length === 0) return { headers: [], rows: [] };

            const parseLine = (line) => {
                const values = [];
                let inQuotes = false;
                let currentValue = '';
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        if (inQuotes && i + 1 < line.length && line[i+1] === '"') { // Handle "" escape for a quote inside a quote
                            currentValue += '"';
                            i++; // Skip the next quote
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        values.push(currentValue.trim());
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                values.push(currentValue.trim()); // Add the last value
                return values.map(val => val.replace(/^"|"$/g, '').replace(/""/g, '"')); // Remove surrounding quotes and unescape ""
            };

            const headers = parseLine(lines[0]);
            const rows = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === "") continue; // Skip empty lines
                const values = parseLine(lines[i]);
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index];
                    });
                    rows.push(row);
                } else {
                    console.warn("Skipping malformed CSV line:", lines[i], "Expected", headers.length, "values, got", values.length, values);
                }
            }
            return { headers, rows };
        }


        async function fetchAndDisplayCSV(gid, tableElementId, loaderElementId, tabName) {
            const sheetUrl = `https://docs.google.com/spreadsheets/d/e/2PACX-1vSlXoH4ekrswe0-BRLB4ZSx8cGjn-3OK-BGcvStNnuOKALm9IfakG4NTOLcYVM6dE7GgQx2f4qNEMDp/pub?gid=${gid}&single=true&output=csv&_=${new Date().getTime()}`;
            const table = document.getElementById(tableElementId);
            const loader = document.getElementById(loaderElementId);
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');

            thead.innerHTML = '';
            tbody.innerHTML = '';
            loader.style.display = 'block';

            console.log(`Fetching data for ${tabName} from: ${sheetUrl}`);

            try {
                const response = await fetch(sheetUrl, { cache: "no-store" }); // Added no-store to try and bypass cache
                console.log(`Response status for ${tabName}: ${response.status}, ok: ${response.ok}`);

                if (!response.ok) {
                    let errorText = `Status: ${response.status} ${response.statusText}.`;
                    try {
                        const bodyText = await response.text();
                        console.error(`Error response body for ${tabName}:`, bodyText);
                        // Avoid showing full HTML error pages in the table cell
                        if (bodyText.toLowerCase().includes("<html")) {
                             errorText += ` Received HTML error page from server.`;
                        } else {
                            errorText += ` Server response: ${bodyText.substring(0, 200)}...`;
                        }
                    } catch (e) {
                        console.warn("Could not read error response body:", e);
                        errorText += ` Could not read error response body.`;
                    }
                    throw new Error(`Network request failed for ${tabName}. ${errorText}`);
                }

                const csvText = await response.text();
                if (!csvText || csvText.trim() === "") {
                    console.warn(`CSV data for ${tabName} is empty or whitespace.`);
                    tbody.innerHTML = `<tr><td colspan="1" style="text-align:center;">No data received for ${tabName}. The sheet might be empty or not published correctly.</td></tr>`;
                    loader.style.display = 'none';
                    return;
                }

                console.log(`Raw CSV for ${tabName}:\n`, csvText.substring(0, 500) + "..."); // Log first 500 chars

                const { headers, rows } = parseCSV(csvText);

                if (!headers || headers.length === 0) {
                     console.error(`No headers found in CSV for ${tabName}. CSV content:`, csvText);
                     throw new Error(`No headers found in CSV for ${tabName}. Check CSV format or if the sheet is empty/published correctly.`);
                }
                console.log(`Parsed Headers for ${tabName}:`, headers);
                console.log(`Number of Parsed Rows for ${tabName}:`, rows.length);


                const headerRow = document.createElement('tr');
                headers.forEach(headerText => {
                    const th = document.createElement('th');
                    th.textContent = headerText;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);

                if (rows.length === 0) {
                     tbody.innerHTML = `<tr><td colspan="${headers.length}" style="text-align:center;">No data rows found for ${tabName} (headers are present).</td></tr>`;
                } else {
                    rows.forEach((rowData, rowIndex) => {
                        // console.log(`Processing row ${rowIndex} for ${tabName}:`, rowData); // Log each row
                        const tr = document.createElement('tr');
                        headers.forEach(header => {
                            const td = document.createElement('td');
                            const cellData = rowData[header] !== undefined ? String(rowData[header]) : ''; // Ensure it's a string

                            // Columns that might contain HTML for links
                            const htmlColumns = ['title', 'letter no.', 'reference'];
                            if (htmlColumns.includes(header.toLowerCase().trim())) {
                               td.innerHTML = cellData;
                            } else {
                               td.textContent = cellData;
                            }
                            tr.appendChild(td);
                        });
                        tbody.appendChild(tr);
                    });
                }

            } catch (error) {
                console.error(`Full error for ${tabName}:`, error);
                const colspanValue = (thead.firstChild && thead.firstChild.children.length > 0) ? thead.firstChild.children.length : 1;
                tbody.innerHTML = `<tr><td colspan="${colspanValue}" style="color:red; text-align:center;">Failed to load data for ${tabName}. ${error.message}. Check console for details.</td></tr>`;
            } finally {
                loader.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchAndDisplayCSV(0, 'rdsoTable', 'loaderRDSO', 'RDSO');
            fetchAndDisplayCSV(737400844, 'railwayBoardTable', 'loaderRailwayBoard', 'Railway Board');
            openTab(null, 'RDSO');
        });

    </script>

</body>
</html>
